<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#1B5E20"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <title>Mercado App</title>
  <link rel="manifest" href="manifest.json"/>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Space+Mono:wght@700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --g1:#1B5E20;--g2:#2E7D32;--g3:#43A047;--gl:#C8E6C9;
      --bg:#F1F8F1;--card:#fff;--text:#1a2e1a;--soft:#6a8f6a;
      --border:#ddeedd;--red:#c62828;--yellow:#e65100;
      --shadow:0 2px 12px rgba(27,94,32,.10);--r:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    html,body{height:100dvh;background:var(--bg);font-family:'Nunito',sans-serif;color:var(--text);overflow:hidden;}
    .screen{display:none;height:100dvh;flex-direction:column;overflow:hidden;}
    .screen.active{display:flex;}

    /* HEADER */
    .header{background:linear-gradient(135deg,var(--g1),var(--g3));color:#fff;padding:16px 20px 20px;flex-shrink:0;border-radius:0 0 28px 28px;box-shadow:0 4px 20px rgba(27,94,32,.3);}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
    .hd-title{font-size:22px;font-weight:900;letter-spacing:-.5px;}
    .hd-sub{font-size:12px;opacity:.8;font-weight:600;margin-top:1px;}
    .btn-icon{background:rgba(255,255,255,.2);border:none;color:#fff;width:38px;height:38px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .budget-box{background:rgba(255,255,255,.15);border-radius:12px;padding:12px 14px;}
    .budget-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .budget-label{font-size:12px;opacity:.85;font-weight:700;}
    .budget-value{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;}
    .budget-track{background:rgba(0,0,0,.2);border-radius:999px;height:8px;overflow:hidden;}
    .budget-fill{height:100%;border-radius:999px;transition:width .5s ease,background .3s;background:#A5D6A7;}
    .budget-warn{font-size:11px;margin-top:5px;text-align:right;font-weight:700;opacity:.9;min-height:16px;}

    /* STATS */
    .stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:14px 16px 0;}
    .stat-card{background:var(--card);border-radius:14px;padding:12px 10px;text-align:center;box-shadow:var(--shadow);border:1px solid var(--border);}
    .stat-icon{font-size:20px;}
    .stat-num{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;color:var(--g1);line-height:1;margin:2px 0;}
    .stat-label{font-size:10px;color:var(--soft);font-weight:700;text-transform:uppercase;letter-spacing:.05em;}

    /* TABS */
    .tabs{display:flex;gap:6px;padding:12px 16px 0;}
    .tab{flex:1;padding:9px 4px;border-radius:12px;border:2px solid var(--border);background:var(--card);color:var(--soft);font-size:12px;font-weight:800;cursor:pointer;text-align:center;transition:all .2s;font-family:'Nunito',sans-serif;}
    .tab.active{background:var(--g1);border-color:var(--g1);color:#fff;}

    /* SCROLL */
    .scroll{flex:1;overflow-y:auto;padding:12px 16px 80px;}
    .scroll::-webkit-scrollbar{display:none;}

    /* ADD BAR */
    .add-bar{padding:10px 16px 16px;background:var(--bg);border-top:1px solid var(--border);flex-shrink:0;}
    .add-row{display:flex;gap:8px;}
    .add-input{flex:1;background:var(--card);border:2px solid var(--border);border-radius:14px;padding:13px 16px;font-size:15px;font-family:'Nunito',sans-serif;color:var(--text);font-weight:600;}
    .add-input:focus{outline:none;border-color:var(--g3);}
    .btn-add{background:var(--g1);color:#fff;border:none;border-radius:14px;width:50px;font-size:26px;cursor:pointer;font-weight:900;flex-shrink:0;}
    .btn-wish{background:#FFF9C4;color:var(--yellow);border:2px solid #FFE082;border-radius:14px;width:50px;font-size:20px;cursor:pointer;flex-shrink:0;}
    .qty-row{display:flex;gap:8px;margin-top:8px;align-items:center;}
    .qty-box{display:flex;align-items:center;gap:8px;background:var(--card);border:2px solid var(--border);border-radius:12px;padding:6px 12px;}
    .qty-btn{background:none;border:none;font-size:22px;color:var(--g2);cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:900;}
    .qty-num{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;min-width:22px;text-align:center;}
    .budget-set{flex:1;display:flex;align-items:center;gap:6px;background:var(--card);border:2px solid var(--border);border-radius:12px;padding:6px 12px;}
    .budget-set label{font-size:11px;color:var(--soft);font-weight:800;white-space:nowrap;}
    .budget-set input{background:none;border:none;font-size:14px;font-family:'Space Mono',monospace;font-weight:700;color:var(--g1);width:70px;outline:none;}

    /* ITEMS */
    .cat-label{font-size:11px;font-weight:900;color:var(--soft);text-transform:uppercase;letter-spacing:.1em;margin:14px 0 6px;}
    .item{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);border:1.5px solid var(--border);margin-bottom:7px;overflow:hidden;transition:opacity .2s;}
    .item.done{opacity:.4;}
    .item-main{display:flex;align-items:center;gap:12px;padding:13px 14px;}
    .check{width:30px;height:30px;border-radius:50%;border:2.5px solid var(--g3);background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;position:relative;}
    .check.checked{background:var(--g2);border-color:var(--g2);}
    .check-tick{display:none;color:#fff;font-size:16px;font-weight:900;}
    .check.checked .check-tick{display:block;}
    .item-info{flex:1;min-width:0;}
    .item-name{font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item.done .item-name{text-decoration:line-through;}
    .item-sub{font-size:11px;color:var(--soft);font-weight:600;margin-top:2px;display:flex;flex-wrap:wrap;align-items:center;gap:5px;}
    .badge{border-radius:6px;padding:2px 6px;font-size:10px;font-weight:800;}
    .badge-up{background:#FFEBEE;color:var(--red);}
    .badge-down{background:#E8F5E9;color:var(--g2);}
    .expand-btn{background:#f0f4f0;border:none;border-radius:8px;padding:7px 11px;color:var(--soft);font-size:12px;cursor:pointer;flex-shrink:0;}
    .item-detail{padding:0 14px 12px;border-top:1px solid var(--border);display:none;}
    .item-detail.open{display:block;}
    .detail-row{display:flex;gap:8px;margin-top:10px;align-items:flex-end;}
    .price-wrap{flex:1;}
    .price-wrap label{font-size:11px;color:var(--soft);font-weight:700;display:block;margin-bottom:4px;}
    .price-input{width:100%;background:var(--bg);border:2px solid var(--border);border-radius:10px;padding:9px 12px;font-size:15px;font-family:'Space Mono',monospace;font-weight:700;color:var(--g1);outline:none;}
    .price-input:focus{border-color:var(--g3);}
    .last-price{font-size:11px;color:var(--soft);margin-top:4px;}
    .subtotal-line{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;color:var(--g2);margin-top:6px;}
    .qty-detail-wrap{flex-shrink:0;}
    .qty-detail-wrap label{font-size:11px;color:var(--soft);font-weight:700;display:block;margin-bottom:4px;}
    .qty-inline{display:flex;align-items:center;gap:4px;background:var(--bg);border:2px solid var(--border);border-radius:10px;padding:4px 8px;}
    .qty-sm{background:none;border:none;font-size:22px;color:var(--g2);cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-weight:900;}
    .qty-inline-val{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;min-width:20px;text-align:center;}
    .detail-btns{display:flex;gap:6px;margin-top:10px;}
    .btn-sm{flex:1;border:none;border-radius:10px;padding:11px 6px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif;}
    .btn-wish-mv{background:#FFF9C4;color:var(--yellow);border:2px solid #FFE082;}
    .btn-del{background:#FFEBEE;color:var(--red);border:2px solid #FFCDD2;}

    /* TOAST */
    #toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:var(--g1);color:#fff;border-radius:20px;padding:10px 20px;font-size:13px;font-weight:700;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap;box-shadow:0 4px 20px rgba(27,94,32,.4);}
    #toast.show{opacity:1;}

    /* REPORT CHART */
    .bar-chart{display:flex;align-items:flex-end;gap:8px;height:100px;padding-top:20px;}
    .bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;}
    .bar-fill{width:100%;border-radius:8px 8px 0 0;min-height:3px;}
    .bar-month{font-size:10px;color:var(--soft);font-weight:700;}
    .report-card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);border:1.5px solid var(--border);padding:16px;margin-bottom:12px;}
    .report-title{font-size:12px;font-weight:900;color:var(--soft);text-transform:uppercase;letter-spacing:.1em;margin-bottom:14px;}
  </style>
</head>
<body>

<div id="toast"></div>

<div id="screen-main" class="screen active">
  <div class="header">
    <div class="header-top">
      <div>
        <div class="hd-title">üõí Mercado</div>
        <div class="hd-sub" id="header-month">Fevereiro 2026</div>
      </div>
      <button class="btn-icon" id="btn-hist-toggle">üïê</button>
    </div>
    <div class="budget-box">
      <div class="budget-row">
        <span class="budget-label">üí∞ OR√áAMENTO</span>
        <span class="budget-value" id="budget-display">R$ 0,00 / ‚Äî</span>
      </div>
      <div class="budget-track">
        <div class="budget-fill" id="budget-fill" style="width:0%"></div>
      </div>
      <div class="budget-warn" id="budget-warn"></div>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-num" id="stat-total">0</div><div class="stat-label">Itens</div></div>
    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-num" id="stat-done">0</div><div class="stat-label">Carrinho</div></div>
    <div class="stat-card"><div class="stat-icon">‚≠ê</div><div class="stat-num" id="stat-wish">0</div><div class="stat-label">Desejos</div></div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="lista">üõí Lista</button>
    <button class="tab" data-tab="desejos">‚≠ê Desejos</button>
    <button class="tab" data-tab="relatorio">üìä Relat√≥rio</button>
  </div>

  <div class="scroll" id="main-scroll">
    <div id="tab-lista">
      <div id="hist-panel" style="display:none; padding: 10px; background: #fff; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border);">
         <p style="font-size: 11px; font-weight: 800; color: var(--soft); margin-bottom: 8px;">SUGEST√ïES</p>
         <div id="hist-chips" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
      </div>
      <div id="items-container"></div>
    </div>
    
    <div id="tab-desejos" style="display:none;">
      <div id="wish-container"></div>
    </div>

    <div id="tab-relatorio" style="display:none;">
      <div class="report-card">
        <div class="report-title">üìä Hist√≥rico Mensal</div>
        <div class="bar-chart" id="chart-months"></div>
      </div>
      <div class="report-card">
        <div class="report-title">üí∞ Total desta compra</div>
        <div style="font-size: 24px; font-weight: 900; color: var(--g1);" id="report-total">R$ 0,00</div>
      </div>
    </div>
  </div>

  <div class="add-bar">
    <div class="add-row">
      <input id="add-input" class="add-input" type="text" placeholder="O que comprar?" autocomplete="off"/>
      <button class="btn-add" id="btn-add">+</button>
      <button class="btn-wish" id="btn-add-wish">‚≠ê</button>
    </div>
    <div class="qty-row">
      <div class="qty-box">
        <button class="qty-btn" id="qty-minus">‚àí</button>
        <span class="qty-num" id="qty-val">1</span>
        <button class="qty-btn" id="qty-plus">+</button>
      </div>
      <div class="budget-set">
        <label>LIMITE R$</label>
        <input type="number" id="budget-input" placeholder="800"/>
      </div>
    </div>
  </div>
</div>

<script>
// --- CONFIG E ESTADO ---
const CATS = {
  "ü•¶ Hortifruti":["banana","ma√ß√£","tomate","batata","cebola","alho","alface"],
  "ü•© A√ßougue":["frango","carne","picanha","lingui√ßa","ovo"],
  "ü•õ Latic√≠nios":["leite","queijo","manteiga","iogurte"],
  "üßπ Limpeza":["detergente","sab√£o","cloro","desinfetante"],
  "üõí Mercearia":["arroz","feij√£o","caf√©","a√ß√∫car","√≥leo","macarr√£o"]
};

let state = JSON.parse(localStorage.getItem('mercado_v1')) || { 
  items:[], wishlist:[], budget:0, priceHistory:{}, monthlyTotals:{}, nextId:1 
};

let activeTab = 'lista';
let addQty = 1;
let histOpen = false;

function save() { localStorage.setItem('mercado_v1', JSON.stringify(state)); }

// --- UTILIT√ÅRIOS ---
function fmtBRL(n) { return 'R$ ' + parseFloat(n||0).toFixed(2).replace('.',','); }

function getCat(name) {
  const n = name.toLowerCase();
  for (const [cat, items] of Object.entries(CATS)) {
    if (items.some(i => n.includes(i))) return cat;
  }
  return "üõí Mercearia";
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2000);
}

// --- RENDERIZA√á√ÉO ---
function render() {
  const total = state.items.reduce((acc, i) => acc + (parseFloat(i.price)||0) * i.qty, 0);
  
  // Header e Or√ßamento
  document.getElementById('budget-display').textContent = `${fmtBRL(total)} / ${state.budget > 0 ? fmtBRL(state.budget) : '‚Äî'}`;
  const pct = state.budget > 0 ? Math.min((total/state.budget)*100, 100) : 0;
  const fill = document.getElementById('budget-fill');
  fill.style.width = pct + '%';
  fill.style.background = pct > 90 ? 'var(--red)' : pct > 70 ? 'var(--yellow)' : '#A5D6A7';

  // Stats
  document.getElementById('stat-total').textContent = state.items.length;
  document.getElementById('stat-done').textContent = state.items.filter(i=>i.checked).length;
  document.getElementById('stat-wish').textContent = state.wishlist.length;

  // Lista principal
  const container = document.getElementById('items-container');
  if (state.items.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">Lista vazia</div>';
  } else {
    container.innerHTML = state.items.map(item => `
      <div class="item ${item.checked?'done':''}">
        <div class="item-main">
          <div class="check ${item.checked?'checked':''}" onclick="toggleCheck(${item.id})">
            <span class="check-tick">‚úì</span>
          </div>
          <div class="item-info" onclick="toggleDetail(${item.id})">
            <div class="item-name">${item.name}</div>
            <div class="item-sub">${getCat(item.name)} ‚Ä¢ ${item.qty}x ${item.price ? fmtBRL(item.price) : ''}</div>
          </div>
          <button class="expand-btn" onclick="toggleDetail(${item.id})">‚ñæ</button>
        </div>
        <div class="item-detail" id="det-${item.id}">
          <div class="detail-row">
            <div class="price-wrap">
              <label>Pre√ßo Unit√°rio</label>
              <input type="number" class="price-input" value="${item.price||''}" oninput="updatePrice(${item.id}, this.value)" placeholder="0,00">
            </div>
            <button class="btn-sm btn-del" onclick="removeItem(${item.id})">Excluir</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Desejos
  document.getElementById('wish-container').innerHTML = state.wishlist.map(i => `
    <div class="report-card" style="display:flex; justify-content:space-between; align-items:center;">
      <div><b>${i.name}</b></div>
      <button class="btn-sm" style="background:var(--g1); color:#fff; border:none; padding:8px; border-radius:8px;" onclick="wishToList(${i.id})">+ Lista</button>
    </div>
  `).join('');

  document.getElementById('report-total').textContent = fmtBRL(total);
}

// --- A√á√ïES ---
window.toggleCheck = (id) => {
  const item = state.items.find(i => i.id === id);
  item.checked = !item.checked;
  save(); render();
};

window.toggleDetail = (id) => {
  const el = document.getElementById(`det-${id}`);
  el.style.display = el.style.display === 'block' ? 'none' : 'block';
};

window.updatePrice = (id, val) => {
  const item = state.items.find(i => i.id === id);
  item.price = val;
  save(); render();
};

window.removeItem = (id) => {
  state.items = state.items.filter(i => i.id !== id);
  save(); render();
};

window.wishToList = (id) => {
  const item = state.wishlist.find(i => i.id === id);
  state.items.push({...item, id: state.nextId++});
  state.wishlist = state.wishlist.filter(i => i.id !== id);
  save(); render();
};

document.getElementById('btn-add').onclick = () => {
  const input = document.getElementById('add-input');
  if (!input.value) return;
  state.items.push({ id: state.nextId++, name: input.value, qty: addQty, price: '', checked: false });
  input.value = ''; addQty = 1; document.getElementById('qty-val').textContent = '1';
  save(); render();
};

document.getElementById('btn-add-wish').onclick = () => {
  const input = document.getElementById('add-input');
  if (!input.value) return;
  state.wishlist.push({ id: state.nextId++, name: input.value, qty: 1 });
  input.value = '';
  save(); render();
  toast("Salvo nos desejos! ‚≠ê");
};

document.getElementById('qty-plus').onclick = () => { addQty++; document.getElementById('qty-val').textContent = addQty; };
document.getElementById('qty-minus').onclick = () => { if(addQty>1) addQty--; document.getElementById('qty-val').textContent = addQty; };

document.getElementById('budget-input').oninput = (e) => {
  state.budget = parseFloat(e.target.value) || 0;
  save(); render();
};

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    activeTab = tab.dataset.tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-lista').style.display = activeTab === 'lista' ? 'block' : 'none';
    document.getElementById('tab-desejos').style.display = activeTab === 'desejos' ? 'block' : 'none';
    document.getElementById('tab-relatorio').style.display = activeTab === 'relatorio' ? 'block' : 'none';
    render();
  };
});

render();
</script>
</body>
</html>
