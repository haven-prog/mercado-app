<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#E8380D" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Mercado</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    :root{--red:#E8380D;--rdark:#be280a;--green:#00A651;--bg:#f5f4f0;--card:#fff;--text:#1c1c1e;--soft:#8E8E93;--border:#ebebeb;--r:18px;--rb:24px;--shadow:0 4px 18px rgba(0,0,0,.08)}
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100dvh;overflow:hidden;background:var(--bg);font-family:Poppins,sans-serif;color:var(--text)}
    #app{height:100dvh;display:flex;flex-direction:column}
    .hero{padding:max(14px,env(safe-area-inset-top)) 16px 14px;background:linear-gradient(145deg,var(--rdark),var(--red) 50%,#ff6c3b);color:#fff}
    .hero-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .hero h1{font-size:24px;font-weight:900;line-height:1}
    .hero small{opacity:.8}
    .round-btn{width:38px;height:38px;border:none;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:17px}
    .budget{background:rgba(255,255,255,.13);border:1px solid rgba(255,255,255,.25);padding:10px;border-radius:14px}
    .row{display:flex;justify-content:space-between;align-items:center}
    .track{height:8px;background:rgba(0,0,0,.2);border-radius:999px;overflow:hidden;margin-top:8px}
    .fill{height:100%;width:0;background:#77ffb2;transition:.25s}
    .warn{font-size:11px;text-align:right;margin-top:4px;min-height:14px}
    .scroll{flex:1;overflow:auto;padding-bottom:10px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:10px 14px}
    .stat{background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:14px;padding:10px;text-align:center}
    .stat b{font-size:20px}
    .sec{padding:10px 14px 4px;color:var(--soft);font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase}
    .empty{background:var(--card);margin:0 14px;padding:30px 20px;border:1px solid var(--border);border-radius:var(--rb);text-align:center;color:var(--soft)}
    .swipe{position:relative;margin:0 14px 10px;overflow:hidden;border-radius:var(--rb)}
    .swipe-bg{position:absolute;inset:0;background:#ffe8e3;display:flex;align-items:center;justify-content:flex-end;padding-right:16px;color:var(--red);font-weight:800}
    .item{position:relative;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:var(--rb);padding:12px;touch-action:pan-y;transition:transform .2s}
    .item.done{opacity:.55}.item.done .name{text-decoration:line-through}
    .item-head{display:flex;gap:10px;align-items:center}.chk{width:24px;height:24px;border-radius:50%;border:2px solid var(--border);background:#fff}.chk.on{background:var(--green);border-color:var(--green)}
    .name{font-weight:700}.meta{font-size:12px;color:var(--soft)} .price{margin-left:auto;font-weight:800;color:var(--green)}
    .controls{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px}
    .inp{width:100%;border:2px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--bg)}
    .qty{display:flex;align-items:center;gap:8px;background:var(--bg);border:2px solid var(--border);border-radius:12px;padding:0 8px}
    .qty button{border:none;background:none;font-size:22px;color:var(--red)}
    .actions{display:flex;gap:6px;margin-top:8px}.pill{border:none;border-radius:10px;padding:8px 10px;font-weight:700;font-size:12px}
    .pill.red{background:#fff0ed;color:var(--red)} .pill.yellow{background:#fff8e1;color:#8a6800}
    .bar{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:10px 14px calc(10px + env(safe-area-inset-bottom));z-index:20}
    .line{display:flex;gap:7px}.line input{flex:1}
    .btn{border:none;border-radius:12px;padding:0 14px;font-size:22px;background:var(--red);color:#fff;font-weight:900}
    .btn.soft{background:#fff8e1;color:#8a6800;border:2px solid #ffe082}
    .mini{display:flex;gap:8px;align-items:center;margin-top:8px}
    .mini .qty{height:42px}.mini .inp{height:42px}
    .tabs{display:flex;background:#fff;border-top:1px solid var(--border);padding:5px 0 calc(6px + env(safe-area-inset-bottom));box-shadow:0 -4px 14px rgba(0,0,0,.04)}
    .tbtn{flex:1;border:none;background:none;font-size:10px;font-weight:700;color:var(--soft)}.tbtn.on{color:var(--red)}.tbtn span{display:block;font-size:21px}
    .tab{display:none}.tab.on{display:block}
    .chips{display:flex;gap:7px;overflow:auto;padding:10px 14px}.chip{border:2px solid var(--border);border-radius:999px;padding:7px 12px;white-space:nowrap;background:#fff;font-size:12px;font-weight:700}.chip.on{background:var(--red);color:#fff;border-color:var(--red)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 14px 12px}.prod{background:#fff;border:1px solid var(--border);border-radius:16px;padding:12px;position:relative;box-shadow:var(--shadow)}.prod b{display:block}
    .fab{position:absolute;top:10px;right:10px;border:none;width:26px;height:26px;border-radius:50%;background:var(--red);color:#fff;font-weight:900}
    .box{margin:0 14px 10px;background:#fff;border:1px solid var(--border);border-radius:var(--rb);box-shadow:var(--shadow);padding:12px}
    .report-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
    .toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:#1c1c1e;color:#fff;opacity:0;pointer-events:none;transition:.2s;z-index:99}
    .toast.on{opacity:1}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:flex-end;z-index:80}.modal.on{display:flex}
    .sheet{background:#fff;width:100%;border-radius:24px 24px 0 0;padding:16px 14px calc(18px + env(safe-area-inset-bottom))}
    video{width:100%;border-radius:14px;background:#000;max-height:42vh}
  </style>
</head>
<body>
<div id="toast" class="toast"></div>
<div id="m-scan" class="modal"><div class="sheet"><h3>üì∑ Ler c√≥digo de barras</h3><p style="font-size:12px;color:var(--soft);margin:6px 0 10px">L√™ o c√≥digo para sugerir item no cat√°logo. Dados ficam s√≥ no seu celular.</p><video id="scan-video" autoplay playsinline muted></video><div class="line" style="margin-top:8px"><input id="manual-code" class="inp" placeholder="Ou digite o c√≥digo"/><button id="manual-add" class="btn" style="font-size:14px">Buscar</button></div><button id="scan-close" class="pill red" style="margin-top:8px;width:100%">Fechar</button></div></div>
<div id="app">
  <header class="hero"><div class="hero-top"><div><h1>üõí Mercado</h1><small id="hero-date"></small></div><div style="display:flex;gap:8px"><button id="btn-install" class="round-btn" title="Instalar">‚¨áÔ∏è</button><button id="btn-scan" class="round-btn" title="Scanner">üì∑</button></div></div><div class="budget"><div class="row"><small>Or√ßamento</small><b id="budget-lbl">R$ 0,00 / ‚Äî</b></div><div class="track"><div id="budget-fill" class="fill"></div></div><div id="budget-warn" class="warn"></div></div></header>
  <main class="scroll" id="scroll">
    <section id="tab-lista" class="tab on"><div class="stats"><div class="stat"><div>üìã</div><b id="s-total">0</b><div style="font-size:11px;color:var(--soft)">Itens</div></div><div class="stat"><div>‚úÖ</div><b id="s-done">0</b><div style="font-size:11px;color:var(--soft)">Carrinho</div></div><div class="stat"><div>üí∞</div><b id="s-left">‚Äî</b><div style="font-size:11px;color:var(--soft)">Restante</div></div></div><div class="sec">Essenciais</div><div id="essentials" class="chips"></div><div id="list"></div></section>
    <section id="tab-catalogo" class="tab"><div id="cat-filter" class="chips"></div><div id="cat-grid" class="grid"></div></section>
    <section id="tab-desejos" class="tab"><div class="box" style="background:#fff8e1;border-color:#ffe082;color:#7a5c00;font-size:12px">‚≠ê Itens para depois. Quando quiser, mova para a lista com um toque.</div><div id="wish"></div></section>
    <section id="tab-relatorio" class="tab"><div class="box"><b>Previs√£o do pr√≥ximo m√™s</b><p id="forecast" style="margin-top:6px;color:var(--soft);font-size:12px"></p></div><div id="sessions"></div></section>
  </main>
  <div class="bar" id="addbar"><button id="finish-btn" class="pill" style="width:100%;background:linear-gradient(135deg,#00A651,#00c863);color:#fff;margin-bottom:8px;padding:12px;border-radius:12px">üéâ Finalizar compra</button><div class="line"><input id="add-input" class="inp" placeholder="Nome do item..."/><button id="btn-add" class="btn">+</button><button id="btn-wish" class="btn soft">‚≠ê</button></div><div class="mini"><div class="qty"><button id="qty-minus">‚àí</button><b id="add-qty">1</b><button id="qty-plus">+</button></div><input id="budget-input" class="inp" inputmode="decimal" placeholder="Or√ßamento R$"/></div></div>
  <nav class="tabs"><button class="tbtn on" data-t="lista"><span>üõí</span>Lista</button><button class="tbtn" data-t="catalogo"><span>üè™</span>Cat√°logo</button><button class="tbtn" data-t="desejos"><span>‚≠ê</span>Desejos</button><button class="tbtn" data-t="relatorio"><span>üìä</span>Relat√≥rio</button></nav>
</div>
<script>
const BUILTIN=[
{id:'b1',n:'Banana',c:'ü•¶ Hortifruti',e:'üçå'},{id:'b2',n:'Tomate',c:'ü•¶ Hortifruti',e:'üçÖ'},{id:'b3',n:'Leite',c:'ü•õ Latic√≠nios',e:'ü•õ'},{id:'b4',n:'Frango',c:'ü•© A√ßougue',e:'üçó'},{id:'b5',n:'Detergente',c:'üßπ Limpeza',e:'üß¥'},{id:'b6',n:'Arroz',c:'üõí Mercearia',e:'üçö'},{id:'b7',n:'P√£o franc√™s',c:'üçû Padaria',e:'ü•ñ'},{id:'b8',n:'Sorvete',c:'‚ùÑÔ∏è Congelados',e:'üç¶'}
];
const CATS=['Todos','ü•¶ Hortifruti','ü•© A√ßougue','ü•õ Latic√≠nios','üçû Padaria','üßπ Limpeza','üõí Mercearia','‚ùÑÔ∏è Congelados'];
const CORRIDOR=['ü•¶ Hortifruti','ü•© A√ßougue','ü•õ Latic√≠nios','üçû Padaria','üõí Mercearia','‚ùÑÔ∏è Congelados','üßπ Limpeza'];
const ESSENTIALS=['Leite','P√£o franc√™s','Ovos','Arroz','Feij√£o'];
const BARCODES={'7894900011517':{n:'Leite',c:'ü•õ Latic√≠nios',e:'ü•õ'},'7891000315507':{n:'Arroz',c:'üõí Mercearia',e:'üçö'},'7891910000197':{n:'Detergente',c:'üßπ Limpeza',e:'üß¥'}};
const DB='mercado-app-db',STORE='kv',KEY='state';

function blank(){return{items:[],wish:[],budget:0,sessions:[],priceHist:{},monthTotals:{},custom:[],nid:1};}
function getCat(n){const t=n.toLowerCase();if(/banana|tomate|alface|cebola/.test(t))return 'ü•¶ Hortifruti';if(/frango|carne|peixe/.test(t))return 'ü•© A√ßougue';if(/leite|queijo|ovo|iogurte/.test(t))return 'ü•õ Latic√≠nios';if(/pao|bolo|biscoito/.test(t))return 'üçû Padaria';if(/sorvete|pizza|lasanha/.test(t))return '‚ùÑÔ∏è Congelados';if(/detergente|sabao|papel/.test(t))return 'üßπ Limpeza';return 'üõí Mercearia';}
function getEmoji(n){const p=[...BUILTIN,...st.custom].find(x=>x.n.toLowerCase()===n.toLowerCase());return p?p.e:'üõçÔ∏è';}
function r(v){return 'R$ '+Number(v||0).toFixed(2).replace('.',',');}
function total(){return st.items.reduce((a,i)=>a+(Number(i.price)||0)*(i.qty||1),0);}
const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('on');clearTimeout(window.__tt);window.__tt=setTimeout(()=>t.classList.remove('on'),2200)};

async function openDb(){return await new Promise((res,rej)=>{const req=indexedDB.open(DB,1);req.onupgradeneeded=()=>req.result.createObjectStore(STORE);req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);});}
async function loadState(){try{const db=await openDb();const data=await new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly').objectStore(STORE).get(KEY);tx.onsuccess=()=>res(tx.result);tx.onerror=()=>rej(tx.error);});db.close();if(data)return {...blank(),...data};}catch{}
try{const old=JSON.parse(localStorage.getItem('mkt3'));if(old)return {...blank(),...old};}catch{}
return blank();}
async function saveState(){try{const db=await openDb();await new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).put(st,KEY);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});db.close();}catch{localStorage.setItem('mkt3',JSON.stringify(st));}}

let st=blank(),tab='lista',qty=1,cat='Todos',deferredInstallPrompt=null,scanTimer=null,scanStream=null;

function orderedItems(){const pending=st.items.filter(i=>!i.checked).sort((a,b)=>CORRIDOR.indexOf(a.cat)-CORRIDOR.indexOf(b.cat));const done=st.items.filter(i=>i.checked);return {pending,done};}
function renderHeader(){document.getElementById('hero-date').textContent=new Date().toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});const t=total(),b=Number(st.budget)||0,p=b?Math.min(100,(t/b)*100):0;document.getElementById('budget-lbl').textContent=`${r(t)} / ${b?r(b):'‚Äî'}`;const fill=document.getElementById('budget-fill');fill.style.width=p+'%';fill.style.background=p>90?'#ff5252':p>70?'#ffb300':'#77ffb2';document.getElementById('budget-warn').textContent=p>90?'‚ö†Ô∏è Or√ßamento estourado':p>70?'‚ö†Ô∏è Pr√≥ximo do limite':'';const bi=document.getElementById('budget-input');if(document.activeElement!==bi)bi.value=b||'';}
function bindSwipe(card,id){let sx=0,x=0;card.addEventListener('pointerdown',e=>{sx=e.clientX;card.setPointerCapture(e.pointerId)});card.addEventListener('pointermove',e=>{x=Math.min(0,Math.max(-94,e.clientX-sx));card.style.transform=`translateX(${x}px)`});card.addEventListener('pointerup',()=>{if(x<-68){st.items=st.items.filter(i=>i.id!==id);saveState();render();toast('üóëÔ∏è Item removido');}card.style.transform='translateX(0)';x=0;});}
function itemCard(i){const subtotal=(Number(i.price)||0)*(i.qty||1);return `<div class="swipe" data-swipe="${i.id}"><div class="swipe-bg">üóë Remover</div><div class="item ${i.checked?'done':''}"><div class="item-head"><button class="chk ${i.checked?'on':''}" data-a="chk" data-id="${i.id}"></button><div>${i.e||'üõçÔ∏è'}</div><div style="flex:1;min-width:0"><div class="name">${i.n}</div><div class="meta">${i.cat} ¬∑ x${i.qty}</div></div>${subtotal?`<div class="price">${r(subtotal)}</div>`:''}</div><div class="controls"><input class="inp" data-a="price" data-id="${i.id}" value="${i.price||''}" placeholder="Pre√ßo unit√°rio" inputmode="decimal"/><div class="qty"><button data-a="q-" data-id="${i.id}">‚àí</button><b>${i.qty}</b><button data-a="q+" data-id="${i.id}">+</button></div></div><div class="actions"><button class="pill yellow" data-a="wish" data-id="${i.id}">‚≠ê Desejos</button><button class="pill red" data-a="del" data-id="${i.id}">Remover</button></div></div></div>`;}
function renderLista(){const list=document.getElementById('list');document.getElementById('s-total').textContent=st.items.length;document.getElementById('s-done').textContent=st.items.filter(i=>i.checked).length;document.getElementById('s-left').textContent=st.budget?r(Math.max(0,st.budget-total())):'‚Äî';document.getElementById('essentials').innerHTML=ESSENTIALS.map(n=>`<button class="chip" data-essential="${n}">+ ${n}</button>`).join('');
  if(!st.items.length){list.innerHTML='<div class="empty">Sem itens. Adicione produtos abaixo ou no cat√°logo.</div>';return}
  const {pending,done}=orderedItems();let html='';let current='';pending.forEach(i=>{if(i.cat!==current){current=i.cat;html+=`<div class="sec">${current}</div>`;}html+=itemCard(i)});if(done.length){html+='<div class="sec" style="opacity:.5">No carrinho</div>';done.forEach(i=>html+=itemCard(i));}list.innerHTML=html;
}
function renderCatalog(){const products=[...BUILTIN,...st.custom].filter(p=>cat==='Todos'||p.c===cat);document.getElementById('cat-filter').innerHTML=CATS.map(c=>`<button class="chip ${cat===c?'on':''}" data-cat="${c}">${c}</button>`).join('');document.getElementById('cat-grid').innerHTML=products.map(p=>`<div class="prod"><button class="fab" data-addp="${p.id}">+</button><div style="font-size:26px">${p.e}</div><b>${p.n}</b><small style="color:var(--soft)">${p.c}</small></div>`).join('')+`<div class="prod" id="new-prod" style="border-style:dashed;display:flex;align-items:center;justify-content:center;min-height:120px;font-weight:700;color:var(--soft)">+ Novo produto</div>`;}
function renderDesejos(){const w=document.getElementById('wish');if(!st.wish.length){w.innerHTML='<div class="empty">Sem itens nos desejos.</div>';return;}w.innerHTML=st.wish.map(i=>`<div class="box"><div class="row"><div><b>${i.e||'‚≠ê'} ${i.n}</b><div style="font-size:12px;color:var(--soft)">${i.cat}</div></div><div><button class="pill" style="background:var(--red);color:#fff" data-wadd="${i.id}">Lista</button> <button class="pill red" data-wdel="${i.id}">Del</button></div></div></div>`).join('');}
function getForecast(){const vals=Object.values(st.monthTotals).slice(-3);if(!vals.length)return 'Finalize compras para gerar previs√£o.';const avg=vals.reduce((a,v)=>a+v,0)/vals.length;const trend=vals.length>1?(vals[vals.length-1]-vals[0])/(vals.length-1):0;const projection=Math.max(0,avg+trend*0.65);return `M√©dia dos √∫ltimos ${vals.length} m√™s(es): ${r(avg)}. Sugest√£o do pr√≥ximo or√ßamento: ${r(projection)}.`;}
function renderReport(){document.getElementById('forecast').textContent=getForecast();const out=document.getElementById('sessions');if(!st.sessions.length){out.innerHTML='<div class="empty">Nenhuma compra finalizada ainda.</div>';return;}out.innerHTML=st.sessions.slice().reverse().map((s,idx)=>`<div class="box"><div class="row"><div><b>${new Date(s.date).toLocaleDateString('pt-BR')}</b><div style="font-size:12px;color:var(--soft)">${s.count} itens</div></div><b style="color:var(--red)">${r(s.total)}</b></div>${(s.items||[]).slice(0,8).map(i=>`<div class="report-item"><span>${i.e||'üõçÔ∏è'} ${i.n} x${i.qty}</span><span>${i.price?r((i.price||0)*i.qty):'‚Äî'}</span></div>`).join('')}<button class="pill red" style="margin-top:8px" data-sdel="${st.sessions.length-1-idx}">Remover sess√£o</button></div>`).join('');}
function renderTab(){document.querySelectorAll('.tab').forEach(el=>el.classList.remove('on'));document.getElementById('tab-'+tab).classList.add('on');document.querySelectorAll('.tbtn').forEach(b=>b.classList.toggle('on',b.dataset.t===tab));document.getElementById('addbar').style.display=tab==='lista'?'block':'none';}
function render(){renderHeader();renderTab();if(tab==='lista')renderLista();if(tab==='catalogo')renderCatalog();if(tab==='desejos')renderDesejos();if(tab==='relatorio')renderReport();bindEvents();}

function addItem(n,q=1,toWish=false,e=getEmoji(n),c=getCat(n)){if(!n.trim())return;const item={id:st.nid++,n:n.trim(),qty:q,price:'',checked:false,e,cat:c};(toWish?st.wish:st.items).push(item);saveState();}
function finalizePurchase(){if(!st.items.length){toast('Adicione itens primeiro');return;}const mkey=new Date().toISOString().slice(0,7);const t=total();st.monthTotals[mkey]=t;st.sessions.push({date:new Date().toISOString(),total:t,count:st.items.length,items:st.items.map(i=>({...i}))});st.items=[];saveState();tab='relatorio';render();toast('‚úÖ Compra finalizada');}

function bindEvents(){document.querySelectorAll('[data-a]').forEach(el=>el.onclick=async()=>{const id=Number(el.dataset.id);const it=st.items.find(i=>i.id===id);if(!it)return;const a=el.dataset.a;if(a==='chk')it.checked=!it.checked;if(a==='q+')it.qty++;if(a==='q-')it.qty=Math.max(1,it.qty-1);if(a==='del')st.items=st.items.filter(i=>i.id!==id);if(a==='wish'){st.wish.push({...it,id:st.nid++});st.items=st.items.filter(i=>i.id!==id);}if(a==='price'){return;}if(it.price){const k=it.n.toLowerCase();st.priceHist[k]=st.priceHist[k]||[];st.priceHist[k].push({m:new Date().toISOString().slice(0,7),price:Number(it.price)})}await saveState();render();});
  document.querySelectorAll('input[data-a="price"]').forEach(inp=>inp.onblur=async()=>{const id=Number(inp.dataset.id);const it=st.items.find(i=>i.id===id);if(!it)return;it.price=inp.value.replace(',','.');await saveState();render();});
  document.querySelectorAll('[data-swipe]').forEach(w=>bindSwipe(w.querySelector('.item'),Number(w.dataset.swipe)));
  document.querySelectorAll('[data-essential]').forEach(b=>b.onclick=async()=>{const n=b.dataset.essential;if(st.items.some(i=>i.n.toLowerCase()===n.toLowerCase()))return toast('J√° est√° na lista');addItem(n,1,false);toast('+ '+n);render();});
  document.querySelectorAll('[data-cat]').forEach(b=>b.onclick=()=>{cat=b.dataset.cat;render();});
  document.querySelectorAll('[data-addp]').forEach(b=>b.onclick=()=>{const p=[...BUILTIN,...st.custom].find(x=>x.id===b.dataset.addp);if(!p)return;addItem(p.n,1,false,p.e,p.c);toast(`+ ${p.n}`);tab='lista';render();});
  const np=document.getElementById('new-prod');if(np)np.onclick=async()=>{const n=prompt('Nome do produto:');if(!n)return;const c=prompt('Categoria (ex: üõí Mercearia):',getCat(n))||getCat(n);const e=prompt('Emoji:','üõçÔ∏è')||'üõçÔ∏è';st.custom.push({id:'u'+Date.now(),n,c,e});await saveState();render();};
  document.querySelectorAll('[data-wadd]').forEach(b=>b.onclick=async()=>{const id=Number(b.dataset.wadd);const it=st.wish.find(i=>i.id===id);if(!it)return;st.items.push({...it,id:st.nid++});st.wish=st.wish.filter(i=>i.id!==id);await saveState();render();});
  document.querySelectorAll('[data-wdel]').forEach(b=>b.onclick=async()=>{st.wish=st.wish.filter(i=>i.id!==Number(b.dataset.wdel));await saveState();render();});
  document.querySelectorAll('[data-sdel]').forEach(b=>b.onclick=async()=>{st.sessions.splice(Number(b.dataset.sdel),1);await saveState();render();});
}

async function initBarcode(){if(!('BarcodeDetector' in window)){toast('BarcodeDetector n√£o suportado no dispositivo');return;}try{scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});const video=document.getElementById('scan-video');video.srcObject=scanStream;const detector=new BarcodeDetector({formats:['ean_13','ean_8','upc_a']});clearInterval(scanTimer);scanTimer=setInterval(async()=>{const codes=await detector.detect(video);if(!codes.length)return;const raw=codes[0].rawValue;const item=BARCODES[raw];if(item){addItem(item.n,1,false,item.e,item.c);toast(`C√≥digo ${raw}: ${item.n}`);closeScan();tab='lista';render();}else{toast('C√≥digo lido: '+raw+' (cadastre no cat√°logo)');}},750);}catch{toast('N√£o foi poss√≠vel abrir a c√¢mera');}}
function closeScan(){document.getElementById('m-scan').classList.remove('on');clearInterval(scanTimer);scanTimer=null;if(scanStream){scanStream.getTracks().forEach(t=>t.stop());scanStream=null;}}

window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredInstallPrompt=e;document.getElementById('btn-install').style.display='inline-block';});

document.querySelectorAll('.tbtn').forEach(b=>b.onclick=()=>{tab=b.dataset.t;render();});
document.getElementById('btn-add').onclick=()=>{const v=document.getElementById('add-input').value.trim();if(!v)return;addItem(v,qty,false);document.getElementById('add-input').value='';qty=1;document.getElementById('add-qty').textContent=qty;render();};
document.getElementById('btn-wish').onclick=()=>{const v=document.getElementById('add-input').value.trim();if(!v)return;addItem(v,qty,true);document.getElementById('add-input').value='';toast('‚≠ê '+v);tab='desejos';render();};
document.getElementById('add-input').onkeydown=(e)=>{if(e.key==='Enter')document.getElementById('btn-add').click();};
document.getElementById('qty-minus').onclick=()=>{qty=Math.max(1,qty-1);document.getElementById('add-qty').textContent=qty;};
document.getElementById('qty-plus').onclick=()=>{qty++;document.getElementById('add-qty').textContent=qty;};
document.getElementById('budget-input').onblur=async(e)=>{st.budget=Number(String(e.target.value).replace(',','.'))||0;await saveState();renderHeader();};
document.getElementById('btn-install').onclick=async()=>{if(deferredInstallPrompt){deferredInstallPrompt.prompt();deferredInstallPrompt=null;return;}toast('Use menu do navegador > Instalar app');};
document.getElementById('btn-scan').onclick=()=>{document.getElementById('m-scan').classList.add('on');initBarcode();};
document.getElementById('finish-btn').onclick=finalizePurchase;
document.getElementById('scan-close').onclick=closeScan;
document.getElementById('m-scan').onclick=(e)=>{if(e.target===e.currentTarget)closeScan();};
document.getElementById('manual-add').onclick=()=>{const c=document.getElementById('manual-code').value.trim();if(!c)return;const item=BARCODES[c];if(item){addItem(item.n,1,false,item.e,item.c);tab='lista';closeScan();render();toast(`+ ${item.n}`);}else toast('C√≥digo n√£o mapeado.');};
document.addEventListener('keydown',e=>{if(e.key==='F'&&e.shiftKey)finalizePurchase();});

(async()=>{st=await loadState();render();if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});} })();
</script>
</body>
</html>
