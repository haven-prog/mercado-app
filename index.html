<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
  <meta name="theme-color" content="#E8380D"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <title>Meu Mercado</title>
  <link rel="manifest" href="manifest.json"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --red:#E8380D; --red2:#FF5722; --green:#00A651; --yellow:#FFB300;
      --bg:#F5F4F0; --card:#ffffff; --text:#1C1C1E; --soft:#8E8E93; --border:#EBEBEB;
      --shadow:0 4px 20px rgba(0,0,0,0.06); --r:16px;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg:#121212; --card:#1E1E1E; --text:#F5F5F5; --soft:#A0A0A0; --border:#2C2C2C;
        --shadow:0 4px 20px rgba(0,0,0,0.3);
      }
    }
    * { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; font-family:'Poppins', sans-serif; }
    html, body { height:100dvh; background:var(--bg); color:var(--text); overflow:hidden; }
    
    .app-container { display:flex; flex-direction:column; height:100dvh; }
    
    /* HEADER */
    .header { background:linear-gradient(135deg, var(--red), var(--red2)); color:#fff; padding:max(env(safe-area-inset-top), 20px) 20px 20px; border-radius:0 0 24px 24px; box-shadow:0 4px 15px rgba(232,56,13,0.3); z-index:10; flex-shrink:0; }
    .header-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .title { font-size:24px; font-weight:800; letter-spacing:-0.5px; }
    
    /* BUDGET WIDGET */
    .budget-box { background:rgba(255,255,255,0.2); border-radius:14px; padding:12px 16px; backdrop-filter:blur(5px); }
    .budget-flex { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px; }
    .budget-labels span { display:block; }
    .budget-labels span:first-child { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; opacity:0.9; }
    .budget-labels span:last-child { font-size:20px; font-weight:800; }
    .budget-input-wrap { display:flex; flex-direction:column; align-items:flex-end; }
    .budget-input-wrap label { font-size:10px; font-weight:600; opacity:0.8; }
    .budget-input { background:none; border:none; border-bottom:2px solid rgba(255,255,255,0.5); color:#fff; font-size:16px; font-weight:700; width:70px; text-align:right; outline:none; font-family:'Poppins', sans-serif; }
    .budget-input::placeholder { color:rgba(255,255,255,0.6); }
    .progress-bg { background:rgba(0,0,0,0.2); height:8px; border-radius:10px; overflow:hidden; }
    .progress-fill { height:100%; background:#fff; border-radius:10px; transition:width 0.4s ease, background 0.3s ease; }
    
    /* SCROLL AREA */
    .scroll-area { flex:1; overflow-y:auto; padding:15px 15px 100px; }
    .scroll-area::-webkit-scrollbar { display:none; }
    
    /* CATEGORIES & ITEMS */
    .cat-title { font-size:13px; font-weight:800; color:var(--soft); text-transform:uppercase; margin:15px 0 8px 5px; display:flex; align-items:center; gap:6px;}
    .item { background:var(--card); border-radius:var(--r); padding:12px 15px; margin-bottom:8px; display:flex; align-items:center; box-shadow:var(--shadow); border:1px solid var(--border); transition:opacity 0.2s; gap:12px; }
    .item.checked { opacity:0.5; }
    .item.checked .item-name { text-decoration:line-through; }
    
    .checkbox { width:26px; height:26px; border-radius:8px; border:2px solid var(--soft); display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.2s; cursor:pointer;}
    .item.checked .checkbox { background:var(--green); border-color:var(--green); }
    .check-icon { color:#fff; font-weight:bold; font-size:14px; opacity:0; }
    .item.checked .check-icon { opacity:1; }
    
    .item-info { flex:1; min-width:0; }
    .item-name { font-size:16px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:2px; }
    
    .item-controls { display:flex; align-items:center; gap:8px; }
    .qty-btn { background:var(--bg); border:1px solid var(--border); color:var(--text); width:28px; height:28px; border-radius:8px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .qty-val { font-size:14px; font-weight:600; min-width:18px; text-align:center; }
    
    .price-input { width:70px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:6px; font-size:13px; font-weight:600; text-align:center; outline:none; }
    .price-input:focus { border-color:var(--red); }
    
    .btn-delete { background:none; border:none; color:var(--red); font-size:20px; cursor:pointer; padding:5px; margin-left:5px; }

    /* ADD BAR (BOTTOM FIX) */
    .add-bar { position:fixed; bottom:0; left:0; width:100%; background:var(--card); padding:10px 15px max(env(safe-area-inset-bottom), 15px); border-top:1px solid var(--border); box-shadow:0 -4px 20px rgba(0,0,0,0.05); display:flex; gap:10px; align-items:center; z-index:20; }
    .add-input { flex:1; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px 15px; font-size:15px; color:var(--text); font-weight:500; outline:none; transition:border 0.2s; }
    .add-input:focus { border-color:var(--red); }
    
    .btn-mic { background:var(--bg); color:var(--red); border:1px solid var(--border); width:48px; height:48px; border-radius:12px; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; }
    .btn-mic.recording { background:#FFEBEE; border-color:var(--red); animation:pulse 1.5s infinite; }
    
    .btn-add { background:var(--red); color:#fff; border:none; width:48px; height:48px; border-radius:12px; font-size:24px; font-weight:600; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 10px rgba(232,56,13,0.3); }

    /* ESSENTIALS SUGGESTION */
    .essentials { display:flex; gap:8px; overflow-x:auto; padding-bottom:10px; margin-bottom:10px; }
    .essentials::-webkit-scrollbar { display:none; }
    .chip { background:var(--card); border:1px solid var(--border); padding:6px 12px; border-radius:20px; font-size:12px; font-weight:600; color:var(--text); white-space:nowrap; cursor:pointer; display:flex; align-items:center; gap:4px; box-shadow:var(--shadow); }
    
    /* TOAST */
    #toast { position:fixed; top:20px; left:50%; transform:translate(-50%, -20px); background:var(--text); color:var(--bg); padding:12px 24px; border-radius:30px; font-size:13px; font-weight:600; opacity:0; pointer-events:none; transition:all 0.3s; z-index:999; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
    #toast.show { opacity:1; transform:translate(-50%, 0); }

    .empty-state { text-align:center; padding:40px 20px; color:var(--soft); }
    .empty-state h3 { color:var(--text); margin-top:10px; font-size:18px; }

    @keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.08); } 100% { transform:scale(1); } }
  </style>
</head>
<body>

<div id="toast">Aviso</div>

<div class="app-container">
  
  <header class="header">
    <div class="header-top">
      <div class="title">üõí Meu Mercado</div>
      <div style="font-size:12px; font-weight:600; opacity:0.8;" id="date-display"></div>
    </div>
    
    <div class="budget-box">
      <div class="budget-flex">
        <div class="budget-labels">
          <span>Gasto Total</span>
          <span id="total-display">R$ 0,00</span>
        </div>
        <div class="budget-input-wrap">
          <label>Or√ßamento Limite</label>
          <input type="number" id="budget-input" class="budget-input" placeholder="R$ 0" />
        </div>
      </div>
      <div class="progress-bg">
        <div class="progress-fill" id="budget-fill" style="width:0%;"></div>
      </div>
      <div style="font-size:11px; margin-top:6px; font-weight:600; text-align:right;" id="budget-warn"></div>
    </div>
  </header>

  <div class="scroll-area" id="scroll-area">
    <div class="essentials" id="essentials-container">
      </div>
    <div id="list-container">
      </div>
  </div>

  <div class="add-bar">
    <button class="btn-mic" id="btn-mic" aria-label="Adicionar por voz">üéôÔ∏è</button>
    <input type="text" id="item-input" class="add-input" placeholder="O que comprar?" autocomplete="off" />
    <button class="btn-add" id="btn-add">+</button>
  </div>

</div>

<script>
// --- CONFIGURA√á√ÉO DE CATEGORIAS E ESSENCIAIS ---
const DICTIONARY = {
  "ü•¶ Hortifr√∫ti": { icon: "ü•¶", words: ["banana","ma√ß√£","tomate","batata","cebola","alho","alface","cenoura","lim√£o","laranja","fruta","verdura"] },
  "ü•© A√ßougue": { icon: "ü•©", words: ["frango","carne","picanha","lingui√ßa","peixe","bife","porco","bacon"] },
  "ü•õ Latic√≠nios": { icon: "ü•õ", words: ["leite","queijo","manteiga","iogurte","ovo","requeij√£o","margarina"] },
  "üßπ Limpeza": { icon: "üßπ", words: ["detergente","sab√£o","cloro","desinfetante","amaciante","esponja","lixo","vassoura"] },
  "üçû Padaria": { icon: "üçû", words: ["p√£o","bolo","biscoito","bolacha","torrada"] },
  "üõí Mercearia": { icon: "üõí", words: ["arroz","feij√£o","caf√©","a√ß√∫car","√≥leo","macarr√£o","sal","farinha","azeite","molho"] }
};

const ESSENTIALS = ["Arroz", "Feij√£o", "Leite", "Ovos", "P√£o", "Caf√©", "Papel Higi√™nico", "Detergente"];

// --- ESTADO (STATE) DO APLICATIVO ---
let state = JSON.parse(localStorage.getItem('mercado_pro')) || { items: [], budget: 0 };

function saveState() {
  localStorage.setItem('mercado_pro', JSON.stringify(state));
  render();
}

// --- FUN√á√ïES UTILIT√ÅRIAS ---
function formatBRL(value) { return 'R$ ' + parseFloat(value || 0).toFixed(2).replace('.', ','); }

function getCategory(name) {
  const normalized = name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  for (const [cat, data] of Object.entries(DICTIONARY)) {
    if (data.words.some(word => normalized.includes(word))) return cat;
  }
  return "üõí Mercearia"; // Default
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// --- RENDERIZA√á√ÉO DA INTERFACE ---
function render() {
  // 1. Data
  document.getElementById('date-display').textContent = new Date().toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'short' }).toUpperCase();
  
  // 2. Or√ßamento e Total
  const total = state.items.reduce((acc, item) => acc + (parseFloat(item.price) || 0) * item.qty, 0);
  document.getElementById('total-display').textContent = formatBRL(total);
  
  const budgetInput = document.getElementById('budget-input');
  if (document.activeElement !== budgetInput) budgetInput.value = state.budget > 0 ? state.budget : '';

  const progress = document.getElementById('budget-fill');
  const warn = document.getElementById('budget-warn');
  
  if (state.budget > 0) {
    const pct = Math.min((total / state.budget) * 100, 100);
    progress.style.width = pct + '%';
    
    if (pct > 95) { progress.style.background = 'var(--red)'; warn.textContent = '‚ö†Ô∏è Or√ßamento Estourado!'; warn.style.color = 'var(--red)'; }
    else if (pct > 75) { progress.style.background = 'var(--yellow)'; warn.textContent = 'Aten√ß√£o ao limite'; warn.style.color = 'var(--yellow)'; }
    else { progress.style.background = '#fff'; warn.textContent = 'Or√ßamento Saud√°vel'; warn.style.color = '#fff'; }
  } else {
    progress.style.width = '0%'; warn.textContent = '';
  }

  // 3. Renderizar Sugest√µes (Essenciais)
  const existingNames = state.items.map(i => i.name.toLowerCase());
  const neededEssentials = ESSENTIALS.filter(e => !existingNames.includes(e.toLowerCase()));
  const essentialsHtml = neededEssentials.map(e => `<div class="chip" onclick="addItem('${e}')">+ ${e}</div>`).join('');
  document.getElementById('essentials-container').innerHTML = essentialsHtml;
  document.getElementById('essentials-container').style.display = neededEssentials.length ? 'flex' : 'none';

  // 4. Renderizar Lista por Categorias
  const container = document.getElementById('list-container');
  if (state.items.length === 0) {
    container.innerHTML = `<div class="empty-state"><h3>Lista Vazia</h3><p>Adicione itens ou toque nas sugest√µes acima.</p></div>`;
    return;
  }

  // Agrupar itens
  const grouped = {};
  state.items.forEach(item => {
    const cat = getCategory(item.name);
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(item);
  });

  let html = '';
  // Ordenar para mostrar n√£o marcados primeiro
  for (const [cat, items] of Object.entries(grouped)) {
    html += `<div class="cat-title">${DICTIONARY[cat] ? DICTIONARY[cat].icon : 'üì¶'} ${cat.replace(/[^a-zA-Z√Ä-√ø\s]/g, '')}</div>`;
    
    items.sort((a, b) => a.checked === b.checked ? 0 : a.checked ? 1 : -1).forEach(item => {
      html += `
        <div class="item ${item.checked ? 'checked' : ''}" data-id="${item.id}">
          <div class="checkbox" onclick="toggleCheck(${item.id})"><span class="check-icon">‚úì</span></div>
          <div class="item-info">
            <div class="item-name" onclick="toggleCheck(${item.id})">${item.name}</div>
            <div class="item-controls">
              <button class="qty-btn" onclick="updateQty(${item.id}, -1)">-</button>
              <span class="qty-val">${item.qty}</span>
              <button class="qty-btn" onclick="updateQty(${item.id}, 1)">+</button>
              <input type="number" class="price-input" placeholder="R$ 0,00" value="${item.price || ''}" onchange="updatePrice(${item.id}, this.value)">
            </div>
          </div>
          <button class="btn-delete" onclick="deleteItem(${item.id})">üóëÔ∏è</button>
        </div>
      `;
    });
  }
  container.innerHTML = html;
}

// --- A√á√ïES DO USU√ÅRIO ---
window.addItem = function(name) {
  if (!name.trim()) return;
  state.items.unshift({
    id: Date.now(),
    name: name.trim().charAt(0).toUpperCase() + name.trim().slice(1),
    qty: 1,
    price: '',
    checked: false
  });
  saveState();
  showToast(`${name} adicionado!`);
};

window.toggleCheck = function(id) {
  const item = state.items.find(i => i.id === id);
  if (item) { item.checked = !item.checked; saveState(); }
};

window.updateQty = function(id, change) {
  const item = state.items.find(i => i.id === id);
  if (item) {
    item.qty += change;
    if (item.qty < 1) item.qty = 1;
    saveState();
  }
};

window.updatePrice = function(id, value) {
  const item = state.items.find(i => i.id === id);
  if (item) { item.price = value; saveState(); }
};

window.deleteItem = function(id) {
  state.items = state.items.filter(i => i.id !== id);
  saveState();
};

// --- LISTENERS DOS INPUTS ---
document.getElementById('btn-add').addEventListener('click', () => {
  const input = document.getElementById('item-input');
  addItem(input.value);
  input.value = '';
});

document.getElementById('item-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') document.getElementById('btn-add').click();
});

document.getElementById('budget-input').addEventListener('change', (e) => {
  state.budget = parseFloat(e.target.value) || 0;
  saveState();
});

// --- INOVA√á√ÉO: RECONHECIMENTO DE VOZ NATIVO ---
const btnMic = document.getElementById('btn-mic');
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.continuous = false;

  recognition.onstart = () => {
    btnMic.classList.add('recording');
    showToast("üé§ Pode falar o item...");
  };

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    addItem(text);
  };

  recognition.onerror = () => { showToast("Erro no microfone. Tente digitar."); };
  recognition.onend = () => { btnMic.classList.remove('recording'); };

  btnMic.addEventListener('click', () => { recognition.start(); });
} else {
  // Se o navegador n√£o suportar (ex: iOS antigo), esconde o bot√£o
  btnMic.style.display = 'none';
}

// --- REGISTO DO SERVICE WORKER (Para instalar como App) ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW falhou:', err));
  });
}

// Inicia o App
render();
</script>
</body>
</html>
